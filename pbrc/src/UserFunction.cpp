#include <iostream>
#include <cstddef>
#include <cstdlib>
#include "UserFunction.hpp"
#include "RobotControl.hpp"

using namespace std;
using namespace nst;


void
demo_function_1(RobotControl * const control,
		shared_ptr<DVSEvent> dvs_ev,
		shared_ptr<SensorEvent> sensor_ev)
{
	static int i = 0;
	++i %= 1000;
	if (!i) {
		cout << "demo function 1 called 1000 times. robot " << unsigned(control->id()) << ". ";

		if (dvs_ev) {
			cout << "triggered by DVS event at ("
				<< dvs_ev->x << ", "
				<< dvs_ev->y << ")"
				<< std::endl;
		}
		if (sensor_ev) {
			cout << "triggered by Sensor Event ("
				<< sensor_ev->imu.m[0] << ", "
				<< sensor_ev->imu.m[1] << ", "
				<< sensor_ev->imu.m[2] << ")"
				<< std::endl;
		}
	}
}

void
demo_function_2(RobotControl * const control,
		shared_ptr<DVSEvent> dvs_ev,
		shared_ptr<SensorEvent> sensor_ev)
{
	static int i = 0;
	++i %= 5000;
	if (!i) {
		cout << "demo function 2 called 5000 times. robot " << unsigned(control->id()) << ". ";
		if (dvs_ev) {
			cout << "triggered by DVS event at ("
				<< dvs_ev->x << ", "
				<< dvs_ev->y << ")"
				<< std::endl;
		}
		if (sensor_ev) {
			cout << "triggered by Sensor Event ("
				<< sensor_ev->imu.m[0] << ", "
				<< sensor_ev->imu.m[1] << ", "
				<< sensor_ev->imu.m[2] << ")"
				<< std::endl;
		}
	}

	// every user function gets called every 15ms without a valid DVS or
	// Sensor event -> use this to send commands to the robot

	// TODO: example to make the robot move
	// voting system to drive left/right --> Braitenberg Vehicle
	if (!sensor_ev && !dvs_ev)
		control->drive(0.0, 0.2);
}


/*
 *
 * reconstructing the LED tracking mechanism for the robot chain
 *
 */
// {{{
const float TimeDevCurve[] = {1,9.801987e-01,9.231163e-01,8.352702e-01,7.261490e-01,6.065307e-01,4.867523e-01,3.753111e-01,2.780373e-01,1.978987e-01,1.353353e-01,8.892162e-02,5.613476e-02,3.404745e-02,1.984109e-02,1.110900e-02,5.976023e-03,3.088715e-03,1.533811e-03,7.318024e-04,3.354626e-04,1.477484e-04,6.252150e-05,2.541935e-05,9.929504e-06,3.726653e-06,1.343812e-06,4.655716e-07,1.549753e-07,4.956405e-08,1.522998e-08,4.496349e-09,1.275408e-09,3.475891e-10,9.101471e-11,2.289735e-11,5.534610e-12,1.285337e-12,2.867975e-13,6.148396e-14,1.266417e-14,2.506222e-15,4.765305e-16,8.705427e-17,1.527980e-17,2.576757e-18,4.175010e-19,6.499348e-20,9.720985e-21,1.396944e-21,1.928750e-22,2.558592e-23,3.261027e-24,3.993337e-25,4.698355e-26,5.311092e-27,5.768330e-28,6.019280e-29,6.034861e-30,5.813239e-31,5.380186e-32,4.784149e-33,4.087335e-34,3.355089e-35,2.646038e-36,2.005009e-37,1.459704e-38,1.021037e-39,6.861930e-41,4.430772e-42,2.748785e-43,1.638439e-44,9.383138e-46,5.162905e-47,2.729407e-48,1.386343e-49,6.765524e-51,3.172198e-52,1.429050e-53,6.185328e-55,2.572209e-56,1.027728e-57,3.945282e-59,1.455145e-60,5.156591e-62,1.755688e-63,5.743283e-65,1.805100e-66,5.450930e-68,1.581496e-69,4.408531e-71,1.180723e-72,3.038296e-74,7.511740e-76,1.784346e-77,4.072359e-79,8.929787e-81,1.881327e-82,3.808166e-84,7.406204e-86,1.383897e-87,2.484505e-89,4.285527e-91,7.102264e-93,1.130883e-94,1.730082e-96,2.542986e-98,3.591282e-100,4.872852e-102,6.352508e-104,7.956744e-106,9.575330e-108,1.107134e-109,1.229915e-111,1.312739e-113,1.346200e-115,1.326383e-117,1.255616e-119,1.142017e-121,9.979685e-124,8.378943e-126,6.759115e-128,5.238641e-130,3.900997e-132,2.791007e-134,1.918556e-136,1.267115e-138,8.040555e-141,4.902123e-143,2.871511e-145,1.616088e-147,8.738722e-150,4.540032e-152,2.266200e-154,1.086840e-156,5.007966e-159,2.217100e-161,9.430558e-164,3.854053e-166,1.513304e-168,5.709040e-171,2.069322e-173,7.206449e-176,2.411253e-178,7.751620e-181,2.394255e-183,7.105203e-186,2.025866e-188,5.549749e-191,1.460710e-193,3.693883e-196,8.974915e-199,2.095105e-201,4.699043e-204,1.012608e-206,2.096532e-209,4.170516e-212,7.970881e-215,1.463697e-217,2.582403e-220,4.377491e-223,7.129428e-226,1.115610e-228,1.677252e-231,2.422771e-234,3.362440e-237,4.483582e-240,5.744125e-243,7.070512e-246,8.361921e-249,9.501441e-252,1.037292e-254,1.088030e-257,1.096501e-260,1.061709e-263,9.877109e-267,8.828412e-270,7.581646e-273,6.255654e-276,4.959183e-279,3.777250e-282,2.764201e-285,1.943532e-288,1.312931e-291,8.521586e-295,5.314068e-298,3.183920e-301,1.832843e-304,1.013717e-307,5.386867e-311,2.750325e-314,1.349149e-317,6.378387e-321,0,0,0,0,0,0,0,0};
const float DistanceDevCurve[] = {1,9.801987e-01,9.231163e-01,8.352702e-01,7.261490e-01,6.065307e-01,4.867523e-01,3.753111e-01,2.780373e-01,1.978987e-01,1.353353e-01,8.892162e-02,5.613476e-02,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
const float xVTable[] = {-36,-3.487507e+01,-3.376800e+01,-3.267878e+01,-3.160742e+01,-3.055391e+01,-2.951826e+01,-2.850047e+01,-2.750053e+01,-2.651845e+01,-2.555422e+01,-2.460785e+01,-2.367934e+01,-2.276868e+01,-2.187588e+01,-2.100093e+01,-2.014384e+01,-1.930461e+01,-1.848323e+01,-1.767971e+01,-1.689404e+01,-1.612623e+01,-1.537628e+01,-1.464418e+01,-1.392994e+01,-1.323355e+01,-1.255503e+01,-1.189435e+01,-1.125153e+01,-1.062657e+01,-1.001947e+01,-9.430219e+00,-8.858826e+00,-8.305289e+00,-7.769608e+00,-7.251783e+00,-6.751814e+00,-6.269701e+00,-5.805444e+00,-5.359043e+00,-4.930498e+00,-4.519809e+00,-4.126976e+00,-3.752000e+00,-3.394879e+00,-3.055614e+00,-2.734205e+00,-2.430653e+00,-2.144956e+00,-1.877116e+00,-1.627131e+00,-1.395003e+00,-1.180730e+00,-9.843140e-01,-8.057536e-01,-6.450493e-01,-5.022010e-01,-3.772088e-01,-2.700725e-01,-1.807924e-01,-1.093682e-01,-5.580011e-02,-2.008804e-02,-2.232004e-03,2.232004e-03,2.008804e-02,5.580011e-02,1.093682e-01,1.807924e-01,2.700725e-01,3.772088e-01,5.022010e-01,6.450493e-01,8.057536e-01,9.843140e-01,1.180730e+00,1.395003e+00,1.627131e+00,1.877116e+00,2.144956e+00,2.430653e+00,2.734205e+00,3.055614e+00,3.394879e+00,3.752000e+00,4.126976e+00,4.519809e+00,4.930498e+00,5.359043e+00,5.805444e+00,6.269701e+00,6.751814e+00,7.251783e+00,7.769608e+00,8.305289e+00,8.858826e+00,9.430219e+00,1.001947e+01,1.062657e+01,1.125153e+01,1.189435e+01,1.255503e+01,1.323355e+01,1.392994e+01,1.464418e+01,1.537628e+01,1.612623e+01,1.689404e+01,1.767971e+01,1.848323e+01,1.930461e+01,2.014384e+01,2.100093e+01,2.187588e+01,2.276868e+01,2.367934e+01,2.460785e+01,2.555422e+01,2.651845e+01,2.750053e+01,2.850047e+01,2.951826e+01,3.055391e+01,3.160742e+01,3.267878e+01,3.376800e+01,3.487507e+01,36};
const float yVTable[] = {-60,-5.999936e+01,-5.999825e+01,-5.999627e+01,-5.999274e+01,-5.998653e+01,-5.997585e+01,-5.995786e+01,-5.992818e+01,-5.988026e+01,-5.980458e+01,-5.968761e+01,-5.951076e+01,-5.924921e+01,-5.887091e+01,-5.833593e+01,-5.759639e+01,-5.659731e+01,-5.527879e+01,-5.357953e+01,-5.144203e+01,-4.881920e+01,-4.568205e+01,-4.202773e+01,-3.788705e+01,-3.333013e+01,-2.846923e+01,-2.345761e+01,-1.848373e+01,-1.376093e+01,-9.512860e+00,-5.956276e+00,-3.282706e+00,-1.641353e+00,-8.206765e-01,1.210878e+00,6.583317e+00,1.509574e+01,2.521450e+01,3.512668e+01,4.350328e+01,4.977979e+01,5.403293e+01,5.668319e+01,5.822562e+01,5.907669e+01,5.952828e+01,5.976163e+01,5.988026e+01,5.994002e+01,5.996999e+01,5.998499e+01,5.999249e+01,5.999625e+01,5.999812e+01,5.999906e+01,5.999953e+01,5.999977e+01,5.999988e+01,5.999994e+01,5.999997e+01,5.999999e+01,5.999999e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,6.000000e+01,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60};
// }}}


#define LED_PERIOD 1000
#define DVS_SIZE 128
static uint64_t lastTimestamps[DVS_SIZE][DVS_SIZE] = {{0}};

struct point_t {
	uint16_t x, y;
};
static point_t curTrackedPoint{64, 40};

void
led_tracker(RobotControl * const control,
	    shared_ptr<DVSEvent> dvs_ev,
	    shared_ptr<SensorEvent> sensor_ev)
{
	static int i = 0;
	const float tao = 0.9f;

	// only watch off polarity
	if (dvs_ev && (dvs_ev->p == 0)) {
		// XXX data is flipped here? wtf?
		uint16_t x = dvs_ev->y;
		uint16_t y = dvs_ev->x;

		auto DVSTimestamp = dvs_ev->t;
		auto lastTimestamp = lastTimestamps[y][x];
		auto deltaT = DVSTimestamp - lastTimestamp;
		auto timeDiff = (deltaT > LED_PERIOD) ? deltaT - LED_PERIOD : LED_PERIOD - deltaT;

		if (timeDiff < 200) {
			float weightT = TimeDevCurve[timeDiff];

			uint16_t xDist = 0;
			if (x > curTrackedPoint.x) xDist = x - curTrackedPoint.x;
			else xDist = curTrackedPoint.x - x;

			uint16_t yDist = 0;
			if (y > curTrackedPoint.y) yDist = y - curTrackedPoint.y;
			else yDist = curTrackedPoint.y - y;

			float weightX = 0.f;
			if (xDist < 127) weightX = DistanceDevCurve[xDist];

			float weightY = 0.f;
			if (yDist < 127) weightY = DistanceDevCurve[yDist];


			float wx = tao * weightX * weightT;
			float wy = tao * weightY * weightT;

			curTrackedPoint.x = (1.f - wx) * curTrackedPoint.x + wx * (float)x;
			curTrackedPoint.y = (1.f - wy) * curTrackedPoint.y + wy * (float)y;

			std::cout << curTrackedPoint.x << ", " << curTrackedPoint.y << std::endl;


		}
		lastTimestamps[y][x] = DVSTimestamp;


		// pull the tracked LED point towards
	}
}
